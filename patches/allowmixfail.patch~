--- nas-1.6e-vanilla/server/dda/voxware/auvoxware.c	2004-09-11 21:23:33.000000000 +0200
+++ nas-1.6e-patched/server/dda/voxware/auvoxware.c	2004-10-17 03:52:01.588978408 +0200
@@ -1422,6 +1422,83 @@
 }
 #endif /* sco */
 
+static AuBool initMixer()
+{
+  unsigned int extramode = 0;
+  AuInt32 i;
+
+#if defined(__CYGWIN__)		/* we want the file to be created if necc under
+				   windows */
+  extramode = O_CREAT;
+#endif
+
+  if ((mixerfd = open(sndStatOut.mixer, O_RDONLY|extramode, 
+    		  0666)) == -1) {
+    UNIDENTMSG;
+    return AuFalse;
+  }
+  
+  if (ioctl(mixerfd, SOUND_MIXER_READ_DEVMASK, &devmask) == -1) {
+    close(mixerfd);
+    mixerfd = -1;
+  } else {
+    if (ioctl(mixerfd, SOUND_MIXER_READ_RECMASK, &recmask) == -1) {
+      return AuFalse;
+    }
+  
+    {
+      /* Enable all used recording sources ( mic & line ) and
+       * control which is active via level setting later. There
+       * should be a better way to do this!
+       */
+     if (!leave_mixer)
+     {
+       int mask = SOUND_MASK_MIC | SOUND_MASK_LINE; /* enable these */
+       mask &= recmask;    /* if supported */
+       if (ioctl(mixerfd, SOUND_MIXER_WRITE_RECSRC, &mask) == -1) 
+         {
+           osLogMsg("%s: ioctl(SOUND_MIXER_WRITE_RECSRC) failed: %s\n",
+                    sndStatOut.mixer,
+                    strerror(errno));
+           /*                return AuFalse; - no need to exit here..*/
+         }
+     }
+    }
+
+    if (ioctl(mixerfd, SOUND_MIXER_READ_RECSRC, &recsrc) == -1) {
+      UNIDENTMSG;
+      osLogMsg("%s: ioctl(SOUND_MIXER_READ_RECSRC) failed: %s\n",
+               sndStatOut.mixer,
+                 strerror(errno));
+      recsrc = 0;
+      /* 	  return AuFalse; - let's not be too hasty */
+    }
+  
+    if (ioctl(mixerfd, SOUND_MIXER_READ_STEREODEVS, &stereodevs) == -1) {
+      UNIDENTMSG;
+      osLogMsg("%s: ioctl(SOUND_MIXER_READ_STEREODEVS) failed: %s\n",
+               sndStatOut.mixer,
+                 strerror(errno));
+      return AuFalse;
+    }
+  
+    /* get all sound levels */
+    for (i = 0; i < SOUND_MIXER_NRDEVICES; i++) {
+      if ((1 << i) & devmask) {
+      
+        if (ioctl(mixerfd, MIXER_READ(i), &level[i]) == -1) {
+          UNIDENTMSG;
+          osLogMsg("%s: ioctl(MIXER_READ(%d)) failed: %s\n",
+                   sndStatOut.mixer,
+                   i,
+                   strerror(errno));
+          return AuFalse;
+        }
+      }
+    }
+  }
+}
+      
 AuBool AuInitPhysicalDevices()
 {
   static AuBool    AL_initialized = AuFalse;
@@ -1539,71 +1616,10 @@
       setupSoundcard(&sndStatIn);
 
     if (!sndStatOut.isPCSpeaker) {
-      if ((mixerfd = open(sndStatOut.mixer, O_RDONLY|extramode, 
-			  0666)) == -1) {
-        UNIDENTMSG;
-        return AuFalse;
-      }
-    
-      if (ioctl(mixerfd, SOUND_MIXER_READ_DEVMASK, &devmask) == -1) {
+      if (initMixer() == AuFalse &&
+          mixerfd != -1) {
         close(mixerfd);
-        mixerfd = -1;
-      } else {
-        if (ioctl(mixerfd, SOUND_MIXER_READ_RECMASK, &recmask) == -1) {
-	  return AuFalse;
-        }
-      
-        {
-          /* Enable all used recording sources ( mic & line ) and
-           * control which is active via level setting later. There
-           * should be a better way to do this!
-           */
-         if (!leave_mixer)
-         {
-           int mask = SOUND_MASK_MIC | SOUND_MASK_LINE; /* enable these */
-           mask &= recmask;    /* if supported */
-           if (ioctl(mixerfd, SOUND_MIXER_WRITE_RECSRC, &mask) == -1) 
-             {
-               osLogMsg("%s: ioctl(SOUND_MIXER_WRITE_RECSRC) failed: %s\n",
-                        sndStatOut.mixer,
-                        strerror(errno));
-               /*                return AuFalse; - no need to exit here..*/
-             }
-         }
-        }
-
-        if (ioctl(mixerfd, SOUND_MIXER_READ_RECSRC, &recsrc) == -1) {
-	  UNIDENTMSG;
-          osLogMsg("%s: ioctl(SOUND_MIXER_READ_RECSRC) failed: %s\n",
-                   sndStatOut.mixer,
-                     strerror(errno));
-          recsrc = 0;
-          /* 	  return AuFalse; - let's not be too hasty */
-        }
-      
-        if (ioctl(mixerfd, SOUND_MIXER_READ_STEREODEVS, &stereodevs) == -1) {
-	  UNIDENTMSG;
-          osLogMsg("%s: ioctl(SOUND_MIXER_READ_STEREODEVS) failed: %s\n",
-                   sndStatOut.mixer,
-                     strerror(errno));
-	  return AuFalse;
-        }
-      
-        /* get all sound levels */
-        for (i = 0; i < SOUND_MIXER_NRDEVICES; i++) {
-	  if ((1 << i) & devmask) {
-	  
-	    if (ioctl(mixerfd, MIXER_READ(i), &level[i]) == -1) {
-	      UNIDENTMSG;
-              osLogMsg("%s: ioctl(MIXER_READ(%d)) failed: %s\n",
-                       sndStatOut.mixer,
-                       i,
-                       strerror(errno));
-	      return AuFalse;
-	    }
-	  }
-        }
-      
+	mixerfd = -1;
       }
     }
   }

-- 
Tobias						PGP: http://9ac7e0bc.uguu.de
German uses a strange mixture of big- and little-endianness: 376 is
pronounced as "Dreihundertsechsundsiebzig", i.e. "three hundred six and
seventy".   -- http://en.wikipedia.org/wiki/Endianess
np: OST - Casino
